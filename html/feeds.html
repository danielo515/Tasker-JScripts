
<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>Single page template</title> 
	 <link rel="stylesheet" href="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.css" />

    <script src="file:///sdcard/Tasker/javascript/lib/jquery-1.11.1.min.js"></script>
 <!-- disable loading msg -->
     <script>
        $(document).bind("mobileinit", function(){
         $.mobile.defaultPageTransition = 'none';
        });
     </script>
    <!-- / -->
    <script src="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.js"></script>
</head> 

<body> 

	<div data-role="page" id="pg-home" data-theme="b">

    <div data-role="header" data-position="fixed" data-id="head1">
        <h1>Control</h1>
			<a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close ui-btn-right">exit</a>
            <a href="#" data-role="button" data-icon="play-circle-o" data-iconpos="notext" class="icon-big ui-btn-left ui-nodisc-icon">exit</a>
    </div><!-- /header -->

	<div data-role="content">	
		<ul data-role="listview" data-inset="true" id="categoryList" data-filter="true">
        </ul>

	</div><!-- /content -->
	
</div><!-- /page -->

	<div data-role="page" id="pg-category" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1">
            
			<div class="ui-btn-left">
				<a href="#pg-home" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Back</a>
			</div>
            <h1>Feed</h1>
			<div class="ui-btn-right">
				<a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
			</div>
		</div><!-- /header -->

		<div data-role="content">	
			<ul data-role="listview" data-inset="true" id="feedList" data-filter="true">
			</ul>
		</div><!-- /content -->
	
	</div><!-- /page -->    
	
		<div data-role="page" id="pg-feed" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1" data-add-back-btn="true">
            <div class="ui-grid-b">
                <div class="ui-block-a">
                    <a href="#pg-category" data-role="button" data-icon="back" data-iconpos="notext">Back</a>
                </div>
                <div class="ui-block-b">
                    <button class="ui-btn ui-icon-audio btn-big ui-btn-icon-left" id="btn-say"  action="play" >PLAY</button>
                </div>
                <div class="ui-block-c">
                    <a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close ui-btn-right" >exit</a>
                </div>
        </div>
		</div><!-- /header -->

		<div data-role="content">	
			<div id="feedItems">
			</div>
		</div><!-- /content -->
			
		<div data-role="footer" data-position="fixed"  data-id="foo-controls">
			
<div class="ui-grid-b">
<div class="ui-block-a">
            <a href="#" class="btn-item-previous btn-big" data-role="button" data-icon="arrow-l" data-iconpos="notext" data-corners="false" >Previous Item</a>
</div><!-- / block a-->	
<div class="ui-block-b">
            <a href="#" class="icon-big ui-nodisc-icon btn-big" data-role="button" data-icon="play-circle-o" data-iconpos="notext"  data-corners="false">exit</a>
</div><!-- / block b-->	
<div class="ui-block-c">
        	<a href="#" class="btn-item-next btn-big" data-role="button" data-icon="arrow-r" data-iconpos="notext"  data-corners="false">Next Item</a>
</div><!-- / block c-->	
</div><!-- / grid-->	
    	</div><!-- /footer -->
	
	</div><!-- /page -->  

<script>
$(function(){
	$(".btn-close").bind( "tap", function( ){destroyScene('feeds');} );
	$(".ui-loader").hide();
  styles = { 'width': '20%',  'display' :'inline'};
  //$('.btn-big').css(styles);
	$("#categoryList").append(feedsStore.listCategories());
	$("#categoryList").listview("refresh");
	$("#btn-say").on("tap",function(){
        var action = $(this).attr("action");
        if(action == "play"){
           flash("Reading current feed...");
            $(this).attr("action","stop"); $(this).text("STOP");$(this).removeClass("ui-icon-audio ui-btn-icon-left");
            feedsStore.say(playFeeds);
        }else{
            feedsStore.stop();
            $(this).attr("action","play");$(this).text("PLAY");$(this).addClass("ui-icon-audio ui-btn-icon-left");
        }
    });
	$(".btn-item-next").on("tap",function(){
		advanceFeed(feedsStore.next);
	}); 
	$(".btn-item-previous").on("tap",function(){
		advanceFeed(feedsStore.previous);
	}); 
	
	//Category Selected
	$("#pg-home").on("tap",".categoryItem",function(){
	  $("#feedList").empty();
	  $("#feedList").append(
		  feedsStore.list( $(this).attr("category"))
	  );
	  $("#feedList").listview("refresh");
  });
	//Feed selected
	$("#pg-category").on("tap",".sourceItem",function(){
		var container = $("#feedItems"),feedName=$(this).attr("feed");
		container.empty();
		container.append(feedsStore.load(feedName));
		$.mobile.navigate($(this).attr("href"));
	});
    
	//direction is a callback function which corresponds to 
	//feedsStore next or previous
	function advanceFeed(direction){
		var container = $("#feedItems");
		container.empty();
		container.append(direction());
		container.trigger('create');
	}
	
    function playFeeds(){
		advanceFeed(feedsStore.next);
        feedsStore.say(playFeeds);
	}

});
var feedsStore = (function(){
    var currentFeed=[]; 
	var currentItem=0,feedsList={},continuous=true;
     loadSources();
    
    function paprseOPM(data){
		 var result = [];
         var $xml = $(data);
        $xml.find("outline").each(function() {
            var $this = $(this),
                item = {
                    title: $this.attr("title"),
                    link: $this.attr("xmlUrl"),
                    description: $this.attr("text"),
					content: $this.attr("content"),
                    type: $this.attr("type")
            };
            result.push(item); 
        });

     return result;
	}
	
    //reads the current feed item and call the callback function if exists. 
    //the callback function receives if a next item exist 
	function sayCurrentFeedItem(callback){
		var item = currentFeed[currentItem],
		text = item.title + composeBody(item.content,item.description);
		for(var i=0; i<text.length; i+=300)
        	say( text.substring(i+300,i) ,"com.google.android.tts", "spa-esp", "media", 7, 5);
        
        if(callback)
            callback( currentItem < currentFeed.length);
	}
    
    function stopTalking(){
        continuous=false;
        performTask("StopTask",10,"ReadFeed");
    }
    
	function sayCurrentFeedTask(callback){
		//start from the current element and onwards \n var items = currentFeed.splice(currentItem), result=[];
		//items.forEach(function(item){
        var item = currentFeed[currentItem], result=[];
        var text = item.title + composeBody(item.content,item.description);
			for(var i=0; i<text.length; i+=300)
				result.push( text.substring(i,i+300) );
		//});
		performTask("ReadFeed",6,result.join("#item#") );
        if( (currentItem < currentFeed.length) && callback )
            taskListener("ReadFeed",function(){ if(continuous)callback();});
	}
    
     // recursively wait for a task to finish
    function taskListener(taskName, callback) {
        if ( taskRunning(taskName) ) {
            setTimeout(taskListener, 250, taskName, callback);
            return;
        }
        callback();
    }
	
    function composeBody(content,description){
		if(content){ content = $( $.parseHTML(content) ).text();}
		if(description){ description =  $( $.parseHTML(description) ).text();}

        if(content && description){
            if( content.indexOf(description.substring(150,0)) >= 0){ //description is contained by content
                return content;
            }else{
                return description + content;
            }
        }else
            return content || description;
    }
	
//parses an XML and extracts the items specified in the itemDesc object	
 function extractItems(data,itemDesc){
	 var result = [],
		 xml = $.parseXML(data), 
         $xml = $(xml),
		 elements = itemDesc.elements;
        $xml.find(itemDesc.name).each(function() {
            var $this = $(this),
		    item = {};
			for(var el in elements){
				item[el] = $this.find(elements[el]).text();
			}
            //Do something with item here...
            result.push(item); 
        });

     return result;
 }
	function loadFeed(feedName){
		currentItem=0;
		var feed = readFile("/sdcard/Tasker/feeds/"+feedName+".xml");
		currentFeed = extractItems(feed, {name: "item",elements: 
									{ title: "title", link: "link", description: "description", 
										   pubDate: "pubDate", content: "encoded", author: "author" 
									}});
		//flash("Feed loaded");
		return renderItem(currentFeed[0]);
	}
    
     function loadSources(){
        var sources = readFile("Tasker/data/feedly.opml"),
	    list = paprseOPM(sources),category="";
        list.forEach(function(i){
		 if(i["type"]){
             feedsList[category].push(i);
         }else{
             category = i.title;
             feedsList[category] = [];
         }	 
		});
    }
	
	function renderItem(item){
		var template='<div class="feedItem"><h3>#title#</h3><div>#feedBody#</div></div>';
		return $(template.replace("#title#",item.title)
				.replace("#feedBody#",composeBody(item.content,item.description)));
		
	}
	
   
	function nextItem(){
		if(currentItem < currentFeed.length -1)
			currentItem += 1;
        else
            currentItem = 0;
		flash("Next item "+currentItem+" of "+currentFeed.length);
		return renderItem(currentFeed[currentItem]);
	}
	
	function previousItem(){
		if(currentItem > 0 )
			currentItem -= 1;
        else
            currentItem = currentFeed.length -1;
		return renderItem(currentFeed[currentItem]);
	}
    
    function listCategories(){
		var template='<li><a href="#pg-category" category="#categoryName#" class="categoryItem">#categoryName#</a></li>',
			result = [];
		for(var i in feedsList){
			result.push(
				$(template.replace(/#categoryName#/g,i))
			);
		}
	  return result;
	}
	
    function listSources(category){
	 var template='<li><a href="#pg-feed" feed="#feedTitle#" class="sourceItem">#feedTitle#</a></li>',
		 result = [],selectedCategory=feedsList[category];
		selectedCategory.forEach( function(item){
                    result.push($(template.replace(/#feedTitle#/g,item.title)));
		});
		return result;
     }
	
	var core={ list:listSources, listCategories:listCategories, load:loadFeed,
			  next:nextItem, previous:previousItem, say:sayCurrentFeedTask, stop:stopTalking};
    return core;
}());
</script>
</body>
    <style>
        #output{
            border: 1px solid;
            font-size: small;
            font-family: monospace;
        }
		#foo-controls{margin :0px !important; padding : 0px !important; } 
		.btn-big 
		{   height: 50px !important; font-size: 1em !important; width: 100% !important; margin :0px !important;}
		.icon-big 
		{ background-size:50px 50px !important; 
		  height: 50px !important; width:50px !important; /*background-position: center;*/
		  }
		.ui-icon-play-circle-o 
		{background: url("data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%20Tiny%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11-tiny.dtd%22%3E%3Csvg%20version%3D%221.1%22%20baseProfile%3D%22tiny%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20width%3D%2216px%22%20height%3D%2216px%22%20viewBox%3D%220%200%20500%20500%22%20xml%3Aspace%3D%22preserve%22%3E%20%3Cpath%20d%3D%22M330.357%20250q0%2010.324-8.929%2015.346l-151.786%2089.286q-4.185%202.511-8.929%202.511-4.464%200-8.929-2.232-8.929-5.301-8.929-15.625v-178.571q0-10.324%208.929-15.625%209.208-5.022%2017.857%200.279l151.786%2089.286q8.929%205.022%208.929%2015.346zM366.071%20250q0-41.294-20.368-76.172t-55.246-55.246-76.172-20.368-76.172%2020.368-55.246%2055.246-20.368%2076.172%2020.368%2076.172%2055.246%2055.246%2076.172%2020.368%2076.172-20.368%2055.246-55.246%2020.368-76.172zM428.571%20250q0%2058.315-28.739%20107.562t-77.985%2077.985-107.562%2028.739-107.562-28.739-77.985-77.985-28.739-107.562%2028.739-107.562%2077.985-77.985%20107.562-28.739%20107.562%2028.739%2077.985%2077.985%2028.739%20107.562z%22%20fill%3D%22%23000000%22%20%2F%3E%3C%2Fsvg%3E")
		 50% 50% no-repeat;}

    </style>
</html>
