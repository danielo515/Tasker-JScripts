
<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>Single page template</title> 
	 <link rel="stylesheet" href="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.css" />

    <script src="file:///sdcard/Tasker/javascript/lib/jquery-1.11.1.min.js"></script>
 <!-- disable loading msg -->
     <script>
        $(document).bind("mobileinit", function(){
         $.mobile.defaultPageTransition = 'none';
        });
     </script>
    <!-- / -->
    <script src="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.js"></script>
    <style>
        #output{
            border: 1px solid;
            font-size: small;
            font-family: monospace;
        }
    </style>
</head> 

<body> 

	<div data-role="page" id="pg-home" data-theme="b">

    <div data-role="header" data-position="fixed" data-id="head1">
        <input type="hidden" id="clipboard"/>
        <div class="ui-btn-left">
            <a href="#" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Copy to clipboard</a>
        </div>
        <h1>Control</h1>
        <div class="ui-btn-right">
            <a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
        </div>
    </div><!-- /header -->

	<div data-role="content">	
		<ul data-role="listview" data-inset="true" id="categoryList" data-filter="true">
        </ul>

	</div><!-- /content -->
	
</div><!-- /page -->

	<div data-role="page" id="pg-category" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1">
            
			<div class="ui-btn-left">
				<a href="#pg-home" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Back</a>
			</div>
            <h1>Feed</h1>
			<div class="ui-btn-right">
				<a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
			</div>
		</div><!-- /header -->

		<div data-role="content">	
			<ul data-role="listview" data-inset="true" id="feedList" data-filter="true">
			</ul>
		</div><!-- /content -->
	
	</div><!-- /page -->    
	
		<div data-role="page" id="pg-feed" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1">
            
			<div class="ui-btn-left">
				<a href="#pg-home" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Back</a>
                <a href="#" data-role="button" data-icon="arrow-l" data-iconpos="notext" class="btn-item-previous">Previous Item</a>
				<button class="ui-btn" id="btn-say"  data-mini="true">READ</button>
			</div>
            <h1>Feed</h1>
			<div class="ui-btn-right">
                <a href="#" data-role="button" data-icon="arrow-r" data-iconpos="notext" class="btn-item-next">Next Item</a>
				<a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
			</div>
		</div><!-- /header -->

		<div data-role="content">	
			<div id="feedItems">
			</div>

		</div><!-- /content -->
	
	</div><!-- /page -->  

<script>
$(function(){
	$(".btn-close").bind( "tap", function( ){destroyScene('feeds');} );
	$(".ui-loader").hide();
	$("#categoryList").append(feedsStore.listCategories());
	$("#categoryList").listview("refresh");
	$("#btn-say").on("tap",function(){feedsStore.say()});
	$(".btn-item-next").on("tap",function(){
		var container = $("#feedItems");
		container.empty();
		container.append(feedsStore.next());
		container.trigger('create');
	}); 
	$(".btn-item-previous").on("tap",function(){
		var container = $("#feedItems");
		container.empty();
		container.append(feedsStore.previous());
		container.trigger('create');
	}); 
	
	$("#pg-home").on("tap",".categoryItem",function(){
	  $("#feedList").empty();
	  $("#feedList").append(
		  feedsStore.list( $(this).attr("category"))
	  );
	  $("#feedList").listview("refresh");
  });
	
	$("#pg-category").on("tap",".sourceItem",function(){
		var container = $("#feedItems"),feedName=$(this).attr("feed");
		container.empty();
		container.append(feedsStore.load(feedName));
		$.mobile.navigate($(this).attr("href"));
	});
    
var feedsStore = (function(){
    var currentFeed=[]; 
	var currentItem=0,feedsList={};
     loadSources();
    
    function paprseOPM(data){
		 var result = [];
         var $xml = $(data);
        $xml.find("outline").each(function() {
            var $this = $(this),
                item = {
                    title: $this.attr("title"),
                    link: $this.attr("xmlUrl"),
                    description: $this.attr("text"),
					content: $this.attr("content"),
                    type: $this.attr("type")
            };
            result.push(item); 
        });

     return result;
	}
	
	function sayCurrentFeed(){
		say(currentFeed[currentItem],"com.google.android.tts", "spa-esp", "media", 7, 7);	
	}
	
//parses an XML and extracts the items specified in the itemDesc object	
 function extractItems(data,itemDesc){
	 var result = [],
		 xml = $.parseXML(data), $xml = $(xml),
		 elements = itemDesc.elements;
        $xml.find(itemDesc.name).each(function() {
            var $this = $(this),
		    item = {};
			for(var el in elements){
				item[el] = $this.find(elements[el]).text()
			}
            //Do something with item here...
            result.push(item); 
        });

     return result;
 }
	function loadFeed(feedName){
		currentItem=0;
		var feed = readFile("/sdcard/Tasker/feeds/"+feedName+".xml");
		currentFeed = extractItems(feed, {name: "item",elements: 
									{ title: "title", link: "link", description: "description", 
										   pubDate: "pubDate", content: "content\\:encoded", author: "author" 
									}});
		flash("Feed loaded");
		return renderItem(currentFeed[0]);
	}
	
	function renderItem(item){
		var template='<div class="feedItem"><h3>#title#</h3><div>#feedBody#</div></div>';
		flashLong(item.title);
		return $(template.replace("#title#",item.title)
				.replace("#feedBody#",item.description/* + items[i].content*/));
		
	}
	
    function loadSources(){
        var sources = readFile("Tasker/data/feedly.opml"),
	    list = paprseOPM(sources),category="";
        list.forEach(function(i){
		 if(i["type"]){
             feedsList[category].push(i);
         }else{
             category = i.title;
             feedsList[category] = [];
         }	 
		});
    }
	
	function nextItem(){
		if(currentItem < currentFeed.length)
			currentItem += 1;
		flashLong("Next item "+currentItem+" of "+currentFeed.length);
		return renderItem(currentFeed[currentItem]);
	}
	
	function previousItem(){
		if(currentItem > 0 )
			currentItem -= 1;
		return renderItem(currentFeed[currentItem]);
	}
    
    function listCategories(){
		var template='<li><a href="#pg-category" category="#categoryName#" class="categoryItem">#categoryName#</a></li>',
			result = [];
		for(var i in feedsList){
			result.push(
				$(template.replace(/#categoryName#/g,i))
			);
		}
	  return result;
	}
	
    function listSources(category){
	 var template='<li><a href="#pg-feed" feed="#feedTitle#" class="sourceItem">#feedTitle#</a></li>',
		 result = [],selectedCategory=feedsList[category];
		selectedCategory.forEach( function(item){
                    result.push($(template.replace(/#feedTitle#/g,item.title)));
		});
		return result;
     }
	
	var core={ list:listSources, listCategories:listCategories, load:loadFeed,
			  next:nextItem, previous:previousItem, say:sayCurrentFeed};
    return core;
}());
</script>
</body>
</html>
