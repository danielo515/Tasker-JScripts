
<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>Single page template</title> 
	 <link rel="stylesheet" href="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.css" />

    <script src="file:///sdcard/Tasker/javascript/lib/jquery-1.11.1.min.js"></script>
 <!-- disable loading msg -->
     <script>
        $(document).bind("mobileinit", function(){
         $.mobile.defaultPageTransition = 'none';
        });
     </script>
    <!-- / -->
    <script src="file:///sdcard/Tasker/javascript/lib/jquery.mobile-1.4.3.min.js"></script>
</head> 

<body> 

	<div data-role="page" id="pg-home" data-theme="b">

    <div data-role="header" data-position="fixed" data-id="head1">
        <input type="hidden" id="clipboard"/>
        <div class="ui-btn-left">
            <a href="#" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Copy to clipboard</a>
        </div>
        <h1>Control</h1>
        <div class="ui-btn-right">
            <a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
        </div>
    </div><!-- /header -->

	<div data-role="content">	
		<ul data-role="listview" data-inset="true" id="categoryList" data-filter="true">
        </ul>

	</div><!-- /content -->
	
</div><!-- /page -->

	<div data-role="page" id="pg-category" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1">
            
			<div class="ui-btn-left">
				<a href="#pg-home" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Back</a>
			</div>
            <h1>Feed</h1>
			<div class="ui-btn-right">
				<a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
			</div>
		</div><!-- /header -->

		<div data-role="content">	
			<ul data-role="listview" data-inset="true" id="feedList" data-filter="true">
			</ul>
		</div><!-- /content -->
	
	</div><!-- /page -->    
	
		<div data-role="page" id="pg-feed" data-theme="b">
		<div data-role="header" data-position="fixed" data-id="head1">
            <div class="ui-grid-b">
                <div class="ui-block-a">
                    <a href="#pg-home" data-role="button" data-icon="back" data-iconpos="notext" class="btn-copy">Back</a>
                    <a href="#" data-role="button" data-icon="arrow-l" data-iconpos="notext" class="btn-item-previous">Previous Item</a>
                </div>
                <div class="ui-block-b">
                    <button class="ui-btn btn-big" id="btn-say"  data-mini="true">READ</button>
                </div>
                <div class="ui-block-c">
                    <a href="#" data-role="button" data-icon="arrow-r" data-iconpos="notext" class="btn-item-next">Next Item</a>
                    <a href="#" data-role="button" data-icon="delete" data-iconpos="notext" class="btn-close">exit</a>
                </div>
        </div>
		</div><!-- /header -->

		<div data-role="content">	
			<div id="feedItems">
			</div>
		</div><!-- /content -->
			
		<div data-role="footer" data-position="fixed"  data-id="foo-controls">
			
<div class="ui-grid-a">
<div class="ui-block-a">
            <a href="#" class="btn-item-previous btn-big" data-role="button" data-icon="arrow-l" data-iconpos="notext" data-corners="false" >Previous Item</a>
</div><!-- / block a-->	
<div class="ui-block-b">
        	<a href="#" class="btn-item-next btn-big" data-role="button" data-icon="arrow-r" data-iconpos="notext"  data-corners="false">Next Item</a>
			</div><!-- / block b-->	
</div><!-- / grid-->	
    	</div><!-- /footer -->
	
	</div><!-- /page -->  

<script>
$(function(){
	$(".btn-close").bind( "tap", function( ){destroyScene('feeds');} );
	$(".ui-loader").hide();
  styles = { 'width': '20%',  'display' :'inline'};
  //$('.btn-big').css(styles);
	$("#categoryList").append(feedsStore.listCategories());
	$("#categoryList").listview("refresh");
	$("#btn-say").on("tap",function(){
        flash("Reading current feed...");
        feedsStore.say(playFeeds);
    });
	$(".btn-item-next").on("tap",function(){
		advanceFeed(feedsStore.next);
	}); 
	$(".btn-item-previous").on("tap",function(){
		advanceFeed(feedsStore.previous);
	}); 
	
	$("#pg-home").on("tap",".categoryItem",function(){
	  $("#feedList").empty();
	  $("#feedList").append(
		  feedsStore.list( $(this).attr("category"))
	  );
	  $("#feedList").listview("refresh");
  });
	
	$("#pg-category").on("tap",".sourceItem",function(){
		var container = $("#feedItems"),feedName=$(this).attr("feed");
		container.empty();
		container.append(feedsStore.load(feedName));
		$.mobile.navigate($(this).attr("href"));
	});
    
	//direction is a callback function which corresponds to 
	//feedsStore next or previous
	function advanceFeed(direction){
		var container = $("#feedItems");
		container.empty();
		container.append(direction());
		container.trigger('create');
	}
	
    function playFeeds(){
		advanceFeed(feedsStore.next);
        feedsStore.say(playFeeds);
	}

});
var feedsStore = (function(){
    var currentFeed=[]; 
	var currentItem=0,feedsList={};
     loadSources();
    
    function paprseOPM(data){
		 var result = [];
         var $xml = $(data);
        $xml.find("outline").each(function() {
            var $this = $(this),
                item = {
                    title: $this.attr("title"),
                    link: $this.attr("xmlUrl"),
                    description: $this.attr("text"),
					content: $this.attr("content"),
                    type: $this.attr("type")
            };
            result.push(item); 
        });

     return result;
	}
	
    //reads the current feed item and call the callback function if exists. 
    //the callback function receives if a next item exist 
	function sayCurrentFeedItem(callback){
		var item = currentFeed[currentItem],
		text = item.title + composeBody(item.content,item.description);
		for(var i=0; i<text.length; i+=3000)
        	say( text.substring(i+3000,i) ,"com.google.android.tts", "spa-esp", "media", 7, 5);
        
        if(callback)
            callback( currentItem < currentFeed.length);
	}
    
	function sayCurrentFeedTask(callback){
		//start from the current element and onwards \n var items = currentFeed.splice(currentItem), result=[];
		//items.forEach(function(item){
        var item = currentFeed[currentItem], result=[];
        var text = item.title + composeBody(item.content,item.description);
			for(var i=0; i<text.length; i+=3000)
				result.push( text.substring(i,i+3000) );
		//});
		performTask("ReadFeed",6,result.join("#item#") );
        if( (currentItem < currentFeed.length) && callback )
            taskListener("ReadFeed",callback);
	}
    
     // recursively wait for a task to finish
    function taskListener(taskName, callback) {
        if ( taskRunning(taskName) ) {
            setTimeout(taskListener, 250, taskName, callback);
            return;
        }
        callback();
    }
	
    function composeBody(content,description){
		if(content){ content = $( $.parseHTML(content) ).text();}
		if(description){ description =  $( $.parseHTML(description) ).text();}

        if(content && description){
            if( content.indexOf(description.substring(150,0)) >= 0){ //description is contained by content
                return content;
            }else{
                return description + content;
            }
        }else
            return content || description;
    }
	
//parses an XML and extracts the items specified in the itemDesc object	
 function extractItems(data,itemDesc){
	 var result = [],
		 xml = $.parseXML(data), 
         $xml = $(xml),
		 elements = itemDesc.elements;
        $xml.find(itemDesc.name).each(function() {
            var $this = $(this),
		    item = {};
			for(var el in elements){
				item[el] = $this.find(elements[el]).text();
                //flash(el + " : " +item[el]);
			}
            //Do something with item here...
            result.push(item); 
        });

     return result;
 }
	function loadFeed(feedName){
		currentItem=0;
		var feed = readFile("/sdcard/Tasker/feeds/"+feedName+".xml");
		currentFeed = extractItems(feed, {name: "item",elements: 
									{ title: "title", link: "link", description: "description", 
										   pubDate: "pubDate", content: "encoded", author: "author" 
									}});
		//flash("Feed loaded");
		return renderItem(currentFeed[0]);
	}
	
	function renderItem(item){
		var template='<div class="feedItem"><h3>#title#</h3><div>#feedBody#</div></div>';
		return $(template.replace("#title#",item.title)
				.replace("#feedBody#",composeBody(item.content,item.description)));
		
	}
	
    function loadSources(){
        var sources = readFile("Tasker/data/feedly.opml"),
	    list = paprseOPM(sources),category="";
        list.forEach(function(i){
		 if(i["type"]){
             feedsList[category].push(i);
         }else{
             category = i.title;
             feedsList[category] = [];
         }	 
		});
    }
	
	function nextItem(){
		if(currentItem < currentFeed.length)
			currentItem += 1;
        else
            currentItem = 0;
		flash("Next item "+currentItem+" of "+currentFeed.length);
		return renderItem(currentFeed[currentItem]);
	}
	
	function previousItem(){
		if(currentItem > 0 )
			currentItem -= 1;
        else
            currentItem = currentFeed.length -1;
		return renderItem(currentFeed[currentItem]);
	}
    
    function listCategories(){
		var template='<li><a href="#pg-category" category="#categoryName#" class="categoryItem">#categoryName#</a></li>',
			result = [];
		for(var i in feedsList){
			result.push(
				$(template.replace(/#categoryName#/g,i))
			);
		}
	  return result;
	}
	
    function listSources(category){
	 var template='<li><a href="#pg-feed" feed="#feedTitle#" class="sourceItem">#feedTitle#</a></li>',
		 result = [],selectedCategory=feedsList[category];
		selectedCategory.forEach( function(item){
                    result.push($(template.replace(/#feedTitle#/g,item.title)));
		});
		return result;
     }
	
	var core={ list:listSources, listCategories:listCategories, load:loadFeed,
			  next:nextItem, previous:previousItem, say:sayCurrentFeedTask};
    return core;
}());
</script>
</body>
    <style>
        #output{
            border: 1px solid;
            font-size: small;
            font-family: monospace;
        }
		#foo-controls{margin :0px !important; padding : 0px !important; } 
		.btn-big 
		{   height: 50px !important; font-size: 1em !important; width: 100% !important; margin :0px !important;
		}
    </style>
</html>
